%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% CAPÍTULO 3
\chapter{Especificações do Projeto}  

\section{Proposta do Trabalho}

O Sistema de Monitoramento de Variações de Tensão de Curta Duração proposto tem como objetivo fornecer uma ferramenta robusta e de baixo custo, que permita a medição da qualidade da energia elétrica fornecida pelas concessionárias de energia através da detecção da ocorrência de eventos de variação de tensão de curta duração. O sistema faz a coleta da informação diretamente na rede de Baixa Tensão (BT), podendo ser tanto 127V quanto 220V

\section{Funcionamento do Protótipo}

O equipamento utilizado neste trabalho foi desenvolvido pelo Prof. Dr. André Sanches Fonseca Sobrinho, para sua tese de doutorado, e foi inicialmente projetado para funcionar como uma Unidade de Medição Fasorial Otimizada para Sistemas de Distribuição \cite{fonsecadesenvolvimento}.

Entre as principais vantagens para a utilização deste equipamento estão sua robustez e o baixo custo de seus componentes. \citeonline{fonsecadesenvolvimento} mostra que, em uma versão final do produto, a placa de desenvolvimento Cerebot MX7cK (que será descrita mais adiante neste capítulo), pode ser substituída por componentes mais baratos e que desempenham apenas as funcionalidades necessárias. Além disso, seu uso permitiu que o foco deste trabalho fosse dado ao desenvolvimento do firmware do sistema.

Para este projeto, o protótipo foi programado para funcionar na detecção dos eventos de variações de tensão de curta duração, classificando-os e disponibilizando-os online para consulta pelo usuário. Para isso, o dispositivo realiza as seguintes atividades:

\begin{itemize}
\item [-] Configuração do relógio em tempo real do microcontrolador PIC32MX795F512L através de dados fornecidos pelo usuário;
\item [-] Coleta dos valores de tensão nas três fases da rede de baixa tensão através da placa de medição trifásica;
\item [-] Cálculo do valor RMS da tensão em cada fase através do circuito integrado ADE7758;
\item [-] Classificação, no caso de ocorrência, dos eventos de VTCD através dos Timers e demais funcionalidades do microcontrolador PIC32MX795F512L. As informações de data e hora da ocorrência de cada eventos são salvas, juntamente com o tipo do evento, na memória RAM do microcontrolador.
\item [-] Disponibilização das informações salvas pelo sistema em um buffer rotativo para consulta  pelo usuário através de uma rede Ethernet.
\end{itemize}  

A figura \ref{fig:fluxograma} ilustra um fluxograma com as atividades desempenhadas pelo Sistema de Monitoramento de Variações de Tensão de Curta Duração.

\begin{figure}[H]
\caption{Fluxograma apresentando a sequência de atividades feitas pelo sistema}
\centering
\includegraphics[width=12cm, height=12cm,keepaspectratio]{./Figuras/fluxograma.jpg}
\label{fig:fluxograma} \fonte{Autoria Própria}
\end{figure}

Na Figura \ref{fig:equipamento} pode-se identificar os componentes que integram o protótipo. É possível observar a placa de desenvolvimento Cerebot MX7cK, que conta com um microcontrolador PIC32MX795F512L e uma entrada para conexão Ethernet, as entradas e saídas das três fases de tensão, o neutro e a placa de medição trifásica, que será descrita mais adiante neste capítulo. 

\begin{figure}[H]
\caption{Estrutura do equipamento}
\centering
\includegraphics[width=12cm, height=12cm,keepaspectratio]{./Figuras/equipamento4.jpg}
\label{fig:equipamento} \fonte{Autoria Própria}
\end{figure}

A caixa plástica que serve de proteção para o equipamento foi testada em laboratórios certificados, levando-se em conta diversas condições climáticas, penetração de água e névoa salina. Os resultados  apresentandos foram satisfatórios, mostrando que o dispositivo pode ser instalado em áreas externas \cite{fonsecadesenvolvimento}. A tabela \ref{tab:caracteristicas} apresenta as principais especificações do dispositivo, tanto da parte elétrica como da parte mecânica.

\begin{table}[H]
    \centering
    \caption{Características elétricas e físicas}
    \label{tab:caracteristicas}
    \scalebox{0.8}{
\begin{tabular}{c|c}
\hline 
Parâmetro  & Valor \\ 
\hline 
Corrente máxima (valor RMS) para cada fase & 141,42 A \\ 
\hline 
Tensão Máxima (valor RMS) para cada fase & 275 V \\ 
\hline 
Consumo do equipamento (alimentado através da fase A) & 3,8 VA \\ 
\hline 
Temperatura de operação & -40 ºC a 85 ºC \\ 
\hline 
Graus de potência (IP) do invólucro mecânico & 55 (contra poeira e jatos d'água) \\ 
\hline 
Dimensões do invólucro mecânico & 412 mm x 230 mm x 100 mm \\ 
\hline 
\end{tabular}}

\fonte{Sobrinho (2016)}
\end{table}

\section{Microcontrolador PIC32MX795F512L}
\label{sec:micro}

Para este trabalho foi utilizado o microcontrolador PIC32MX795F512L, fabricado pela empresa \textit{Microchip Technology Incorporated}, que possui unidade de processamento de 32 bits, 512 kB de memória Flash, 128 kB de memória RAM, frequência de operação de 80 MHz e faixa de operação de tensão de 2,3 V a 3,6 V \cite{microchip:pic32}.

O PIC32MX795F512L conta com 5 Timers de 16 bits, que podem ser combinados em pares para formar Timers de 32 bits. Além disso, o microcontrolador conta com a presença de uma interface para Controle de Acesso ao Meio (MAC) de 10/100 Mbps, que permite a implementação de uma conexão física Ethernet \cite{microchip:pic32}. 

O periférico de calendário e relógio em tempo real, também presente no microcontrolador, permite a contagem do tempo em horas, minutos e segundos, a consulta por dia da semana, dia, mês e ano, além de otimização para uso contínuo da bateria e correção de ano bissexto. O erro apresentado é de aproximadamente $\pm$ 0,66 segundos por mês \cite{microchip:pic32}.

Além das funcionalidades mencionadas, outro módulo deste microcontrolador que é útil para o trabalho é o módulo de interface serial SPI, um protocolo de comunicação serial que será explicado com mais detalhes na seção \ref{sec:spi}. Esse módulo possui suporte para configurações mestre e escravo, quatro formatos de clock diferentes, suporte para padrão 8, 16 ou 32 bits, entre outros.  

\begin{figure}[H]
\caption{Placa de desenvolvimento Cerebot MX7cK}
\centering
\includegraphics[width=8cm, height=6cm,keepaspectratio]{./Figuras/cerebot.png}
\label{fig:cerebot} \fonte{Diligent Incorporated (2013) \nocite{cerebot:mx7ck}}
\end{figure}

O microcontrolador PIC32MX795F512L foi utilizado através da placa de desenvolvimento Cerebot MX7cK, que é fabricada pela empresa \textit{Digilent Incorporated}. Essa placa possui 52 pinos de entrada e saída, interface Ethernet 10/100, 5 entradas de interrupção externa e diversos outros periféricos, podendo ser alimentada via USB ou fonte AC-DC externa. \cite{cerebot:mx7ck}. Um diagrama com os principais periféricos da Cerebot MX7cK é apresentado na figura \ref{fig:cerebot}:

\begin{figure}[H]
\caption{Diagrama do circuito da placa Cerebot MX7cK}
\centering
\includegraphics[width=8cm, height=8cm,keepaspectratio]{./Figuras/cerebotDiagram.png}
\label{fig:cerebot} \fonte{Diligent Incorporated (2013) \nocite{cerebot:mx7ck}}
\end{figure}


\section{Placa de Medição Trifásica}

O ADE7758, circuito integrado fabricado pela empresa \textit{Analog Devices}, é um medidor de energia elétrica trifásico de alta precisão. Ele conta com uma interface serial compatível com o protocolo SPI, e alimentação de 5V. Esse circuito integrado conta com uma entrada analógica para cada um dos três canais de corrente e três canais de tensão \cite{analogdevices:ade7758}. 

\begin{figure}[H]
\caption{Configuração de pinos do circuito integrado ADE7758}
\centering
\includegraphics[width=8cm, height=8cm,keepaspectratio]{./Figuras/ADE7758.png}
\label{fig:ade7758} \fonte{Adaptado de Analog Devices (2011) \nocite{analogdevices:ade7758}}
\end{figure}

O ADE7758 é responsável pela conversão analógico-digital dos sinais lidos pelos três canais de tensão	, disponibilizando então o valor RMS da tensão da rede para o microcontrolador.
	
O desenvolvimento da placa de medição trifásica, utilizada neste trabalho para a aquisição dos sinais de tensão, é descrito em Sobrinho (2016). Como é possível observar na Figura \ref{fig:placamedicao}, esse dispositivo conta com conexões para as três fases de tensão, interface lógica com a placa do microcontrolador, fonte AC/DC e conexão com o neuto da rede.

Através da utilização de divisores resistivos é possível atenuar a tensão de entrada para os limites adequados ao conversor A/D do circuito integrado ADE7758 \cite{fonsecadesenvolvimento}. A Equação (\ref{eq:atenuacao}) expressa essa relação, onde $V_N$ é a tensão em um dos canais do ADE7758, e $V_{IN}$ é a tensão proveniente de uma das fases da rede trifásica.

\begin{equation}
\label{eq:atenuacao}
V_N = \frac{1k\Omega}{1k\Omega + 1M\Omega}V_{IN} = 9,99 \cdot 10^{-4} V_{IN}
\end{equation} 

De acordo com o datasheet do ADE7758, a faixa de operação das entradas analógicas é de $\pm 500     mV$ \cite{analogdevices:ade7758}. Desta maneira, a partir da Equação (\ref{eq:atenuacao}) é possível determinar um valor máximo de $500,5 V$ nas entradas de tensão da placa, o que resultará no valor de $500 mV$ na entrada do conversor A/D. Isso permite que tanto tensões com valor RMS de 127 V e 220 V sejam amostradas.  

\begin{figure}[H]
\caption{Placa para aquisição dos sinais de tensão}
\centering
\includegraphics[width=12cm, height=12cm,keepaspectratio]{./Figuras/placamedicao.jpg}
\label{fig:placamedicao} \fonte{Adaptado de Sobrinho (2016)}
\end{figure}

\subsection{Interface de Comunicação}
\label{sec:spi}

A interface de comunicação utilizada para a troca de dados entre o microcontrolador e o circuito integrado ADE7758 foi a interface de comunicação serial SPI (\textit{Serial Peripheral Interface}), um protocolo de comunicação serial síncrona, desenvolvido pela \textit{Motorola}, que permite a troca de informações entre dispositivos. Sua maior utilização se dá em sistemas embarcados, estabelecendo a comunicação entre microcontroladores e outros periféricos, como conversores A/D, circuitos integrados, EEPROMs seriais, entre outros. \cite{leens2009introduction, microchip:pic32}.

O protocolo SPI usa uma topologia mestre-escravo, onde um dispositivo "mestre" envia e requisita dados de um ou mais dispositivos "escravos". A comunicação se dá em quatro linhas de sinal (\textit{four wire serial bus}):

\begin{itemize}
\item [-]Um sinal de clock (SCLK), enviando pelo dispositivo mestre para um ou mais dispositivos escravos, definindo a síncronização de toda a comunicação entre os dispositivos.
\item [-]Uma linha para troca de dados do mestre para o(s) escravo(s), MOSI (Master Out-Slave In).
\item [-]Uma linha para troca de dados do(s) escravo(s) para o mestre, MISO (Master In-Slave Out).
\item [-]Um sinal de seleção de escravo (SSn), único para cada dispositivo escravo, que é usado para selecionar com qual dispositivo escravo o mestre irá se comunicar.
\end{itemize}

A Figura \ref{fig:spi1} ilustra a configuração da interface de comunicação SPI, com suas quatro linhas de sinal, em um sistema com um mestre e um escravo, enquanto na Figura \ref{fig:spi2} é possível ver como se dá a expansão dessa configuração para múltiplos dispositivos escravos.

\begin{figure}[H]
\caption{Topologia da comunicação SPI - Um mestre e um escravo}
\centering
\includegraphics[width=10cm, height=8cm,keepaspectratio]{./Figuras/SPI_1.jpg}
\label{fig:spi1} \fonte{Autoria Própria}
\end{figure}

\begin{figure}[H]
\caption{Topologia da comunicação SPI - Um mestre para um ou mais escravos}
\centering
\includegraphics[width=10cm, height=8cm,keepaspectratio]{./Figuras/SPI_2.jpg}
\label{fig:spi2} \fonte{Autoria Própria}
\end{figure}

Como mencionado anteriormente, o microcontrolador PIC32MX795F512L possui quatro interfaces SPI, e a utilizada para este trabalho foi a SPI canal 1. O microcontrolador foi configurado como um dispositivo mestre, enquanto o circuito integrado atua como escravo. 

\section{Lógica do Firmware}

Após o completo entendimento de todos os dispositivos que compõem o protótipo, é necessário também entender o funcionamento do seu código, ou seja, do Firmware programado. Essa lógica foi desenvolvida de maneira a utilizar todas as funcionalidades do microcontrolador e do circuito integrado, descritos anteriormente, para atingir os objetivos propostos na seção \ref{sec:objetivo}.

\subsection{Aquisição da tensão RMS da rede elétrica}
\label{subsec:rms}


O valor eficaz da tensão das três fases da rede fica armazenado em um dos registradores de 24 bits disponíveis no ADE7758: AVRMS (0x0D), BVRMS (0x0E) e CVRMS (0x0F). Uma interrupção com o Timer2 foi então programada para ocorrer a cada 100 ms, tempo necessário para os registradores refletirem o valor lido na entrada do conversor. \cite{analogdevices:ade7758}. 

De acordo com o Datasheet, para garantir a estabilidade da medida é recomendável realizar a leitura em sincronia com o início da onda da tensão. Para que isso seja possível, o circuito integrado conta com o pino IRQ (pino 18, como mostrado na Figura \ref{fig:ade7758}), que, através da configuração do registrador \textit{Mask}, vai para nível lógico baixo para indicar a ocorrência de uma determinada interrupção.

 A Figura \ref{fig:irq} ilustra esse comportamento de maneira simplificada. Quando o sinal da tensão cruza o eixo x (no início da onda), o valor do pino IRQ vai para nível lógico baixo, indicando a ocorrência desse evento. Para que o valor do pino retorne ao nível lógico alto, é necessária a leitura do registrador RSTATUS. 

\begin{figure}[H]
\caption{IRQ}
\centering
\includegraphics[width=10cm, height=8cm,keepaspectratio]{./Figuras/irq.JPG}
\label{fig:irq} \fonte{Adaptado de \citeonline{analogdevices:ade7758}}
\end{figure}

O último passo para a obtenção do valor RMS da tensão é o escalonamento do sinal. De acordo com \citeonline{analogdevices:ade7758}, o valor dos registradores de tensão em máxima escala é de 1639101 unidades (rede de 60 Hz), o que equivale a um valor de tensão RMS de aproximadamente 353.91 V. Desta maneira, temos que cada 4.631 unidades lidas no registrador equivalem a $1 \ mV_{RMS}$.

\begin{equation}
\label{eq:rms}
\frac{1639101 \ unidades}{353907 \ mV_{RMS}} = \frac{4.631 \ unidades}{1 \ mV}
\end{equation}

Devido ao elevado valor dos resistores presentes nos divisores resistivos, o valor encontrado na equação \ref{eq:rms} não é exato, sendo necessária uma análisa manual, com ajuda de um multímetro, para definir os valores corretos para o cálculo. Essa análise foi feita em \citeonline{fonsecadesenvolvimento}, e o resultado é apresentado a seguir:

\begin{table}[H]
    \centering
    \caption{Fatores de conversão para cálculo da tensão RMS}
    \label{tab:norm}
    \scalebox{0.8}{
\begin{tabular}{c|c|c}
\hline 
\multicolumn{3}{c}{Valor de conversão para 60 Hz (unidades/mV)} \\ 
\hline 
Fase A & Fase B & Fase C \\ 
\hline 
4,6278 & 4,7515 & 4,6527 \\ 
\hline 
\end{tabular}}

\fonte{Adaptado de \citeonline{fonsecadesenvolvimento}}
\end{table}

O cálculo da tensão RMS é feito da seguinte maneira:

\begin{itemize}
\item [-] O registrador RSTATUS é lido para garantir que o pino IRQ estará em nível lógico alto no início da operação.
\item [-] O registrador Mask é configurado para gerar uma interrupção no início da onda de tensão da fase selecionada.
\item [-] O microcontrolador aguarda a ocorrência da interrupção monitorando o pino RD12, que é conectado ao pino IRQ.
\item [-] Após a ocorrência da interrupção, o registrador RSTATUS é lido novamente para resetar o indicador de interrupção.
\item [-] É feita a leitura do registrador correspondente à fase de tensão desejada (AVRMS, BVRMS ou CVRMS), para obter o valor RMS da tensão.
\item [-] O valor lido é dividido pelo fator de conversão correspondente da tabela \ref{tab:norm} para se obter o valor em $V_{RMS}$
\item [-] O processo é reiniciado para a próxima fase de tensão.
\end{itemize}

\subsection{Classificação dos eventos de VTCD}

Como descrito na seção \ref{subsec:rms}, o microcontrolador PIC32MX795F512L gera, com o TIMER2, uma interrupção a cada 100 ms, e dentro dessa interrupção são obtidos os valores de tensão eficaz de cada uma das fases da rede. 

Após esse cálculo, é feito o monitoramento do valor de tensão lido. Caso o valor esteja abaixo de 0.9 pu (interrupção ou afundamento) ou acima de 1.1 pu (elevação), o sistema ativará uma interrupção periódica em um dos Timers disponíveis no microcontrolador, como mostra a tabela \ref{tab:calculo}. 

\begin{table}[H]
    \centering
    \caption{Timers utilizados para classificação das VTCD}
    \label{tab:calculo}
    \scalebox{0.8}{
\begin{tabular}{c|c|c|c}
\hline 
- & Fase A & Fase B & Fase C \\ 
\hline 
Timer & 3 & 4 & 5 \\ 
\hline 
Tempo & 16 ms & 10 ms & 15 ms \\ 
\hline 
\end{tabular}}

\fonte{Autoria Própria}
\end{table}

O período de interrupção dos Timers 3, 4 e 5 foi escolhido de maneira a permitir uma verificação do limite inferior de duração de afundamentos e elevações momentâneas, que é de um ciclo da rede. Nesse caso, para uma rede de 60 Hz, um ciclo leva aproximadamente 16.67 ms.

Dentro de cada interrupção há um contador, que é incrementado sempre que uma interrupção é gerada. Assim, caso o valor do contador seja igual a 1, não houve distúrbio na fase correspondente. Cada Timer possui um valor diferente de período para evitar possíveis atrasos no processamento.

Quando o valor da tensão correspondente retorna a faixa normal de operação, a interrupção é desabilitada e é feito o cálculo da duração total do evento, que é então classificado como  momentâneo ou temporário. Por último, essa informação é salva, juntamente com os valores dos registradores RTCDATE e RTCTIME, em um buffer rotativo, e o contador é zerado para o próximo evento. 

Como exemplo, caso a leitura da tensão RMS da Fase A da rede apresente um valor abaixo de 0.9 pu (114.4 V, para uma rede de $127 \ V_{RMS}$), o Timer3 será ativado, gerando uma interrupção a cada 16 ms. Se, após o retorno da tensão para o valor correto, o valor do contador for igual a 01, isso significará que o evento de afundamento teve a duração de 1 ciclo da rede e, de acordo com a tabela \ref{tab:VTCD}, será classificado como um evento de Afundamento Momentâneo de Tensão. Essa informação será salva, junto com a hora e a data da ocorrência (valores de RTCDATE e RTCTIME), disponibilizada para o usuário através de uma rede Ethernet, que será explicada com mais detalhes no capítulo 4. 
