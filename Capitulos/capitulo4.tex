%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% CAPÍTULO 4
\chapter{Troca de Dados}

Este capítulo tem como objetivo descrever o sistema de comunicação e de transmissão de dados do sistema de monitoramento de variações de tensão de curta duração. Será explicado o fucionamento da comunicação Ethernet, dos protocolos MAC, TCP e IP, o software Hercules e o protocolo de comunicação SPI.

\section{Arquitetura da Rede}

\subsection{Protocolo TCP/IP}

O protocolo TCP/IP é, na verdade, um conjunto de protocolos que especifícam como deve ser feita a transmissão de dados em rede (empacotamento, endereçamento, transmissão, roteamento e recebimento de dados). Seu nome vem de dois dos seus principais protocolos, o Protocolo de Controle da Transmissão (\textit{Transmission Control Protocol - TCP}) e o Protocolo de Internet (\textit{Internet Protocol - IP}), que atuam nas camadas de transporte e internet, respectivamente \cite{torres2001rede}. A Figura \ref{fig:tcpip} ilustra a arquitetura do TCP/IP, com quatro camadas. 

\begin{figure}[H]
\caption{Camadas do protocolo TCP/IP}
\centering
\includegraphics[width=6cm, height=6cm,keepaspectratio]{./Figuras/TCP_IP.jpg}
\label{fig:tcpip} \fonte{Adaptado de Torres (2001)}
\end{figure}

Para que seja possível fazer a comunicação do microcontrolador PIC32MX795F512L em uma rede, é necessário implementar o protocolo TCP/IP. Para isso, a empresa Microchip fornece sua própria pilha TCP/IP, chamada de "\textit{Microchip TCP/IP Stack}". O código de configuração das diferentes camadas é colocado em arquivos separados junto com o firmware do protótipo \cite{microchipTCP}. 

\begin{figure}[H]
\caption{Estrutura da pilha TCP/IP da Microchip comparada com a arquitetura TCP/IP}
\centering
\includegraphics[width=12cm, height=12cm,keepaspectratio]{./Figuras/pilhatcp.jpg}
\label{fig:tcpipmicrochip} \fonte{Adaptado de Microchip Technolgy Incorporated (2008b)}
\end{figure}

\subsection{Comunicação Ethernet}

A arquitetura Ethernet é um conjunto de tecnologias para redes de computadores, utilizada principalmente para redes locais (\textit{Local Area Network - LAN}), que define a forma de transmissão dos dados. O padrão Ethernet recebe dados de protocolos de alto nível, como TCP/IP, e define fisicamente como se dará a transmissão pelos cabos de rede. O protocolo Ethernet é definido pela especificação IEEE 802.3 \cite{torres2001rede, microchipEthernet}.

Para que seja possível a configuração de uma rede local, é necessário também uma camada de Controle de Acesso ao Meio (\textit{Media Access Control - MAC}). Essa camada é responsável por garantir o endereçamento dos dados a serem transmitidos, inserindo tanto as informações do dispositivo emissor quanto do dispositivo receptor. Esses dispositivos (placas de rede) possuem o chamado endereço MAC, um endereço único que é gravado fisicamente em uma memória ROM na placa de rede \cite{torres2001rede}.

 Como foi descrito na seção \ref{sec:micro}, o microcontrolador PIC32MX795F512L possui uma interface para Controle de Acesso ao Meio (MAC) de 10/100 Mbps. Além disso, o microcontrolador conta também com um endereço único MAC, programado no momento da fabricação pela empresa Microchip \cite{microchip2013b}.
 
 Desta maneira, o dispositivo proposto neste trabalho possui uma arquitetura de rede que utiliza o conjunto de protocolos TCP/IP, fornecidos pela própria fabricante, juntamente com um padrão Ethernet para a transmissão física dos dados. A Figura \ref{fig:tcpethernet} ilustra essa configuração.

\begin{figure}[H]
\caption{Rede com protocolo TCP/IP e padrão Ethernet}
\centering
\includegraphics[width=6cm, height=6cm,keepaspectratio]{./Figuras/arquiteturaethernet.jpg}
\label{fig:tcpethernet} \fonte{Adaptado de Torres (2001)}
\end{figure}

\section{Transmissão de Dados}
\label{hercules}

Para este trabalho, o protótipo do Sistema de Monitoramento de Variações de Tensão de Curta Duração foi configurado como um dispositivo "Servidor", ou seja, um dispositivo que possui um endereço IP fixo e que se conecta com outros dispositivos, chamados de "Clientes", que podem solicitar dados sempre que necessário. Estes dados podem ser a data e hora atuais do sistema, eventos de variação de tensão em cada fase salvos no buffer rotativo, o tipo do evento, entre outros.

\begin{figure}[H]
\caption{Ethernet}
\centering
\includegraphics[width=8cm, height=8cm,keepaspectratio]{./Figuras/ethernet.jpg}
\label{fig:tcpethernet} \fonte{Adaptado de Sobrinho (2016)}
\end{figure}

Para que fosse possível estabelecer uma conexão com o Sistema de Monitoramento de Variações de Tensão de Curta Duração, configurado como um dispositivo "Servidor" na rede TCP/IP, era necessário configurar também um dispositivo "Cliente". Para isso, foi utilizado o software \textit{Hercules}, desenvolvido pela empresa \textit{HW Group}. Esse software funciona como um terminal TCP/IP, podendo ser configurado tanto como um dispositivo cliente quanto como servidor. 

A Figura \ref{fig:hercules} ilustra a interface do software na opção "\textit{TCP Client}". É possível observar as diferentes opções de uso (cliente e servidor TCP, Serial, UDP, etc.), o campo com mensagens de dados que são enviadas na comunicação, dados enviados como resposta e a Porta e o endereço IP do dispositivo remoto.

\begin{figure}[H]
\caption{Hercules}
\centering
\includegraphics[width=14cm, height=14cm,keepaspectratio]{./Figuras/hercules2.jpg}
\label{fig:hercules} \fonte{Autoria Própria}
\end{figure}

\section{Mensagens}
\label{sec:mess}

Para possibilitar a troca de informações entre o usuário e o sistema, foram configuradas algumas mensagens padrão que serão explicadas a seguir. Essas mensagens servem tanto para o envio de dados e configurações do microcontrolador, como hora e data, como para a solicitação de informações quando necessário, como no caso da ocorrência de eventos.

\subsection{Configure Date and Time - CDT}

O objetivo dessa mensagem é permitir ao usuário configurar os registradores RTCDATE e RTCTIME do microcontrolador PIC32MX795F512L, ajustando a hora e a data do periférico de calendário e relógio em tempo real, descrito na seção \ref{sec:micro}. Caso a configuração seja feita de maneira correta, o sistema enviará a mensagem "OK" como resposta, como ilustra a Figura \ref{fig:cdt}.

\begin{figure}[H]
\caption{CDT}
\centering
\includegraphics[width=10cm, height=10cm,keepaspectratio]{./Figuras/CDT.jpg}
\label{fig:cdt} \fonte{Autoria Própria}
\end{figure}

A mensagem deve iniciar com os caracteres "CDT", em caixa alta, indicando a operação que o microcontrolador deverá realizar, seguido por dia e hora, nos formados dd/mm/aaaa e hh:mm:ss. 

\subsection{Verify Date and Time - VDT}

Caso seja necessário verificar a hora e data atuais do sistema, o usuário deverá utilizar a mensagem VDT, que retorna os valores dos registradores RTCDATE e RTCTIME do microcontrolador. Na Figura \ref{fig:vdt} é possível verificar um exemplo dessa mensagem. 

\begin{figure}[H]
\caption{VDT}
\centering
\includegraphics[width=10cm, height=10cm,keepaspectratio]{./Figuras/VDT.jpg}
\label{fig:vdt} \fonte{Autoria Própria}
\end{figure}

\subsection{FA, FB e FC}

Por último, as mensagens FA, FB e FC servem para verificação da ocorrência de eventos de variações de tensão de curta duração em cada uma das fases da tensão. Caso não tenham ocorrido eventos na fase requisitada, o sistema retornará a mensagem "NO". Caso contrário, será mostrado a data, hora e tipo do último evento salvo. 

\begin{figure}[H]
\caption{FA}
\centering
\includegraphics[width=10cm, height=10cm,keepaspectratio]{./Figuras/fa.jpg}
\label{fig:fa} \fonte{Autoria Própria}
\end{figure}
